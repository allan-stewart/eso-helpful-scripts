<html>
    <head>
        <title>Letter Frequency</title>
        <style>
            body {
                font-family: Helvetica, Arial, sans-serif;
            }

            .bar-container {
                display: block;
                position: relative;
                height: 250px;
                border: 1px solid lightgray;
            }

            .bar {
                position: absolute;
                display: inline-block;
                width: 20px;
                bottom: 0;
                left: 0;
            }

            .expected {
                background-color: gray;
            }

            .actual {
                background-color: lightblue;
                width: 15px;
                left: 2px;
            }

            .frequency {
                display: inline-block;
                width: 20px;
            }

            #frequency-distribution {
                margin: 10px 0;
            }
        </style>
    </head>
    <body>
        <h1>Letter Frequency</h1>
        <textarea id="the-text" cols="100" rows="7" onkeyup="analyze()">THIS IS AN EXAMPLE. IF YOU ADD ENOUGH words into the frequency analysis, you will hopefully get somewhere close to the standard values for written English. The trick for me will be to figure out how these differ from the expected values.</textarea>
        <div id="frequency-distribution"></div>
        <div>Standard deviation: <span id="standard-deviation"></span></div>
        <div>Chi Squared Goodness of Fit: if <span id="chi-squared"></span> >= 37.655 then NOT English w/ 5% margin of error</div>
    </body>
    <script>
        function analyze() {
            const text = document.getElementById('the-text').value
            const letterCounts = getLetterCounts(text)
            console.log('letterCounts', letterCounts)
            drawFrequencies(letterCounts)
            document.getElementById('standard-deviation').innerHTML = calculateStandardDeviation(letterCounts)
            document.getElementById('chi-squared').innerHTML = chiSquaredGoodnessOfFit(letterCounts)
            
            /*
            Need to also check other things like:
            - are there any vowels? (maybe)
            - number of unique words
            - length of the words?
            - total number of words?
            - outliers - whether there are too many of a single character (beyond a couple standard deviations?)
            */
        }

        function calculateStandardDeviation(letterCounts) {
            var differences = letterCounts.map(x => englishFrequencies[x.letter] - x.frequency)
            var averageDifference = sum(differences) / differences.length
            var sumOfSquaredDifferencesMinusAverageDifference = sum(differences.map(x => Math.pow((x - averageDifference), 2)))
            var standardDeviation = sumOfSquaredDifferencesMinusAverageDifference / (differences.length - 1)
            return standardDeviation
        }

        function chiSquaredGoodnessOfFit(letterCounts) {
            //chi-squared goodness of fit formula
            //Χ^2 = Σ [ (Oi - Ei)^2 / Ei ]
            //DF = k - 1 // degrees of freedom always = 25
            // Compare X^2 to table at .05 (5% risk of getting it wrong), if it is greater or equal to the table then not English.
            // .05 value for 25 DF = (36.42 + 38.89) / 2 = 37.655
            // .01 value for 25 DF = (42.98 + 45.64) / 2

            // Also check out Effect Size Phi for Chi-square test
            // phi = sqrt(X^2 / n)
            // where n = the number of observations. A value of .1 is considered a small effect, .3 a medium effect and .5 a large effect.

            // Zac says not to reduce to percentages (0-1) too quickly because we lose info.
            // Instead do Oi = number of that letter, and Ei = expected number of that letter based on the normal frequency
            // But he isn't sure whether DF would change in that case... it might still work for 26-1,
            // or it might need to be the total number of characters - 1 (the latter means the X^2 chart will need to be dynamic...)

            var chiSquared = sum(letterCounts.map(x => {
                const observed = x.frequency
                const expected = englishFrequencies[x.letter]
                return Math.pow((observed - expected), 2) / expected
            }))

            var updated = sum(letterCounts.map(x => Math.pow((x.actual - x.expected), 2) / x.expected))

            console.log('chiSquared original:', chiSquared, `vs. updated:`, updated)

            return chiSquared
        }

        function sum(array) {
            return array.reduce((sum, x) => sum + x, 0)
        }

        function getLetterCounts(text) {
            var counts = 'abcdefghijklmnopqrstuvwxyz'.split('').reduce((acc, x) => {acc[x] = 0; return acc}, {})
            var lower = text.toLowerCase();
            var total = 0;
            for (var i = 0; i < lower.length; i++) {
                var char = lower[i]
                if (counts[char] >= 0) {
                    counts[char]++
                    total++
                }
            }
            var letters = Object.keys(counts)
            var totalCharacters = sum(letters.map(x => counts[x]))
            console.log('total characters', totalCharacters)
            return letters.map(x => ({letter: x, actual: counts[x], expected: totalCharacters * englishFrequencies[x], frequency: total > 0 ? (counts[x]/total) : 0}));
        }

        function drawFrequencies(letterCounts) {
            var html = letterCounts.map(drawFrequencyBar)
            document.getElementById('frequency-distribution').innerHTML = html.join('\n')
        }

        function drawFrequencyBar(x) {
            return `<div class="frequency">` +
                `<div class="bar-container">` +
                    `<div class="bar expected" style="height: ${calculateBarHeight(englishFrequencies[x.letter])}%;"></div>` +
                    `<div class="bar actual" style="height: ${calculateBarHeight(x.frequency)}%;"></div>` +
                `</div>` +
                `${x.letter}` + 
            `</div>`
        }

        function calculateBarHeight(percentage) {
            return Math.min(percentage * 500, 100)
        }

        var englishFrequencies = {
            'a': .082, 'b': .015, 'c': .028, 'd': .043, 'e': .130, 'f': .022,
            'g': .020, 'h': .061, 'i': .070, 'j': .0015, 'k': .0077, 'l': .040,
            'm': .024, 'n': .067, 'o': .075, 'p': .019, 'q': .000095, 'r': .060,
            's': .063, 't': .091, 'u': .028, 'v': .0098, 'w': .024, 'x': .0015,
            'y': .020, 'z': .0074
        }

        var englishFrequencies_alt = {
            'a': .073, 'b': .009, 'c': .030, 'd': .044, 'e': .130, 'f': .028,
            'g': .016, 'h': .035, 'i': .074, 'j': .002, 'k': .003, 'l': .035,
            'm': .025, 'n': .078, 'o': .074, 'p': .027, 'q': .003, 'r': .077,
            's': .063, 't': .093, 'u': .027, 'v': .013, 'w': .016, 'x': .005,
            'y': .019, 'z': .001
        }

        analyze()
    </script>
</html>